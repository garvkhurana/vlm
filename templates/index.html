<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturing Video Analysis System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
        .main-container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        
        /* Header */
        .header-card { background: rgba(255,255,255,0.98); backdrop-filter: blur(10px); border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin-bottom: 30px; padding: 40px; }
        .header-content { display: flex; align-items: center; justify-content: space-between; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .header-icon { width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4); }
        .header-text h1 { font-size: 32px; font-weight: 700; color: #1a202c; margin-bottom: 5px; }
        .header-text p { color: #718096; font-size: 16px; }
        .status-badge { display: flex; align-items: center; gap: 8px; background: #d4edda; padding: 12px 20px; border-radius: 12px; }
        .status-indicator { width: 10px; height: 10px; background: var(--success-color); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.95); } }
        
        /* Grid Layout */
        .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        
        /* Cards */
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); padding: 30px; margin-bottom: 30px; }
        .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
        .card-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; }
        .card-title { font-size: 22px; font-weight: 600; color: #2d3748; }
        
        /* Upload Zones */
        .upload-zone { border: 3px dashed #cbd5e0; border-radius: 16px; padding: 40px; transition: all 0.3s; background: #f8f9fa; text-align: center; cursor: pointer; }
        .upload-zone:hover { border-color: var(--primary-color); background: #f0f4ff; transform: translateY(-2px); }
        .upload-icon { font-size: 48px; color: #cbd5e0; margin-bottom: 15px; }
        .upload-zone:hover .upload-icon { color: var(--primary-color); }
        .upload-title { font-size: 18px; font-weight: 600; color: #2d3748; margin-bottom: 8px; }
        .upload-subtitle { font-size: 14px; color: #718096; margin-bottom: 20px; }
        .upload-button { background: var(--primary-color); color: white; border: none; padding: 12px 30px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .upload-button:hover { background: var(--secondary-color); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        .file-name { margin-top: 12px; font-size: 14px; color: var(--success-color); font-weight: 500; }
        
        /* Submit Button */
        .submit-button { width: 100%; background: linear-gradient(135deg, var(--success-color), #059669); color: white; border: none; padding: 18px; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer; transition: all 0.3s; margin-top: 20px; }
        .submit-button:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4); }
        .submit-button:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* Download Button */
        .download-section { margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #e0e7ff, #f3e8ff); border-radius: 12px; }
        .download-buttons { display: flex; gap: 12px; margin-top: 12px; }
        .download-btn { flex: 1; background: var(--primary-color); color: white; border: none; padding: 14px 20px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .download-btn:hover { background: var(--secondary-color); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        .download-btn i { font-size: 18px; }
        
        /* Checklist Items */
        .checklist-container { max-height: 600px; overflow-y: auto; }
        .checklist-item { background: #f8f9fa; border-radius: 12px; padding: 18px; margin-bottom: 12px; border-left: 5px solid #cbd5e0; transition: all 0.4s; position: relative; display: flex; align-items: flex-start; gap: 12px; }
        .checklist-item.analyzing { background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left-color: var(--warning-color); }
        .checklist-item.satisfied { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-left-color: var(--success-color); }
        .checklist-item.not-satisfied { background: linear-gradient(135deg, #fee 0%, #fdd 100%); border-left-color: var(--danger-color); }
        .checklist-item:hover { transform: translateX(5px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .status-circle { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; flex-shrink: 0; transition: all 0.4s; }
        .status-circle.analyzing { background: var(--warning-color); color: white; animation: spin 2s linear infinite; }
        .status-circle.satisfied { background: var(--success-color); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        .status-circle.not-satisfied { background: var(--danger-color); color: white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); }
        
        .item-content { flex: 1; }
        .item-text { font-size: 15px; color: #2d3748; font-weight: 500; line-height: 1.5; margin-bottom: 6px; }
        .item-evidence { font-size: 13px; color: #718096; line-height: 1.4; margin-top: 6px; }
        .item-timestamps { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
        .timestamp-badge { background: rgba(102, 126, 234, 0.1); color: var(--primary-color); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        
        /* Three Dot Menu */
        .menu-dots { cursor: pointer; padding: 8px; color: #718096; transition: color 0.2s; position: relative; }
        .menu-dots:hover { color: var(--primary-color); }
        .menu-dropdown { display: none; position: absolute; right: 0; top: 100%; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 100; min-width: 200px; overflow: hidden; }
        .menu-dropdown.active { display: block; animation: menuSlide 0.2s ease-out; }
        @keyframes menuSlide { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .menu-item { padding: 14px 18px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 12px; color: #2d3748; font-size: 14px; font-weight: 500; }
        .menu-item:hover { background: #f8f9fa; }
        .menu-item i { width: 20px; }
        
        .checkmark-animation { animation: checkmarkPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes checkmarkPop { 
            0% { opacity: 0; transform: scale(0) rotate(-45deg); } 
            50% { transform: scale(1.2) rotate(10deg); }
            100% { opacity: 1; transform: scale(1) rotate(0deg); } 
        }
        
        /* Analysis Content */
        .analysis-content { background: white; border-radius: 16px; padding: 30px; margin-top: 20px; }
        .analysis-content h1, .analysis-content h2, .analysis-content h3 { color: var(--primary-color); margin: 20px 0 12px; }
        .analysis-content h1 { font-size: 28px; }
        .analysis-content h2 { font-size: 24px; }
        .analysis-content h3 { font-size: 18px; }
        .analysis-content p { color: #4a5568; line-height: 1.8; margin-bottom: 12px; }
        .analysis-content ul, .analysis-content ol { margin-left: 20px; color: #4a5568; line-height: 1.8; }
        .analysis-content li { margin-bottom: 8px; }
        .analysis-content table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .analysis-content table th { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 12px; text-align: left; }
        .analysis-content table td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .analysis-content code { background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        .analysis-content pre { background: #f1f5f9; padding: 16px; border-radius: 8px; overflow-x: auto; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #94a3b8; }
        .empty-state i { font-size: 64px; margin-bottom: 20px; }
        .empty-state p { font-size: 16px; }
        
        /* Loading Overlay */
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .loading-overlay.active { display: flex; }
        .loading-content { background: white; border-radius: 20px; padding: 40px; text-align: center; max-width: 400px; }
        .spinner { width: 60px; height: 60px; border: 5px solid #e2e8f0; border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Progress */
        .progress-container { margin: 20px 0; }
        .progress-label { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: 600; color: #2d3748; }
        .progress-bar-outer { background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .progress-bar-inner { background: linear-gradient(90deg, var(--success-color), #059669); height: 100%; border-radius: 10px; transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: white; font-size: 12px; font-weight: 600; }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .content-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 20px; text-align: center; }
            .download-buttons { flex-direction: column; }
        }
        
        .step-section { margin-bottom: 30px; }
        .step-header { 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .step-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header-card">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-icon">
                        <i class="fas fa-industry"></i>
                    </div>
                    <div class="header-text">
                        <h1>Manufacturing Video Analysis</h1>
                        <p>AI-Powered Safety & Process Monitoring</p>
                    </div>
                </div>
                <div class="status-badge">
                    <div class="status-indicator"></div>
                    <span style="color: #2d3748; font-weight: 600;">System Online</span>
                </div>
            </div>
        </div>

        <div class="content-grid">
            <!-- Left Column -->
            <div>
                <!-- Upload Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                        <h2 class="card-title">Upload Files</h2>
                    </div>
                    
                    <form id="uploadForm">
                        <!-- Video Upload -->
                        <div class="upload-zone" onclick="document.getElementById('videoFile').click()">
                            <div class="upload-icon"><i class="fas fa-video"></i></div>
                            <div class="upload-title">Manufacturing Video</div>
                            <div class="upload-subtitle">Upload your manufacturing process video</div>
                            <input type="file" id="videoFile" accept="video/*" style="display: none;">
                            <button type="button" class="upload-button" onclick="event.stopPropagation(); document.getElementById('videoFile').click()">
                                <i class="fas fa-plus"></i> Select Video
                            </button>
                            <div id="videoFileName" class="file-name"></div>
                        </div>

                        <div style="height: 20px;"></div>

                        <!-- SOP Upload -->
                        <div class="upload-zone" onclick="document.getElementById('sopFile').click()">
                            <div class="upload-icon"><i class="fas fa-file-alt"></i></div>
                            <div class="upload-title">Standard Operating Procedure</div>
                            <div class="upload-subtitle">Upload your SOP document (PDF or TXT)</div>
                            <input type="file" id="sopFile" accept=".txt,.pdf" style="display: none;">
                            <button type="button" class="upload-button" onclick="event.stopPropagation(); document.getElementById('sopFile').click()">
                                <i class="fas fa-plus"></i> Select SOP
                            </button>
                            <div id="sopFileName" class="file-name"></div>
                        </div>

                        <button type="submit" class="submit-button" id="submitBtn">
                            <i class="fas fa-play"></i> Start Analysis
                        </button>
                    </form>
                </div>

                <!-- Analysis Results -->
                <div id="analysisCard" class="card" style="display: none;">
                    <div class="card-header">
                        <div class="card-icon"><i class="fas fa-chart-line"></i></div>
                        <h2 class="card-title">Video Analysis Report</h2>
                    </div>
                    <div id="analysisContent" class="analysis-content"></div>
                    
                    <!-- Download Section -->
                    <div class="download-section">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 12px;">
                            <i class="fas fa-download" style="font-size: 28px; color: var(--primary-color);"></i>
                            <div>
                                <h4 style="color: #2d3748; font-weight: 600; margin-bottom: 4px;">Download Report</h4>
                                <p style="color: #718096; font-size: 14px;">Export your analysis report</p>
                            </div>
                        </div>
                        <div class="download-buttons">
                            <button class="download-btn" onclick="downloadHTML()">
                                <i class="fas fa-file-code"></i>
                                <span>Download Report</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Checklist -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon"><i class="fas fa-clipboard-check"></i></div>
                        <h2 class="card-title">SOP Compliance Checklist</h2>
                    </div>
                    
                    <div id="checklistContainer" class="checklist-container">
                        <div class="empty-state">
                            <i class="fas fa-clipboard"></i>
                            <p>Upload files to generate compliance checklist</p>
                        </div>
                    </div>

                    <div id="checklistProgress" style="display: none; margin-top: 20px;">
                        <div class="progress-label">
                            <span>Compliance Rate</span>
                            <span id="progressText">0/0</span>
                        </div>
                        <div class="progress-bar-outer">
                            <div id="checklistProgressBar" class="progress-bar-inner" style="width: 0%;">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3 style="color: #2d3748; font-size: 20px; font-weight: 600; margin-bottom: 10px;">Processing Video</h3>
            <p style="color: #718096;">Extracting frames and analyzing...</p>
        </div>
    </div>

    <script>
        let globalChecklistData = [];
        let globalReportMarkdown = '';
        const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB limit

        // File validation function
        function validateFile(file, type) {
            if (!file) return { valid: false, error: 'No file selected' };
            if (file.size > MAX_FILE_SIZE) return { valid: false, error: 'File size exceeds 100MB limit' };
            
            if (type === 'video') {
                if (!file.type.startsWith('video/')) return { valid: false, error: 'Invalid video file format' };
            } else if (type === 'sop') {
                const validTypes = ['application/pdf', 'text/plain'];
                if (!validTypes.includes(file.type)) return { valid: false, error: 'Invalid SOP file format (PDF or TXT only)' };
            }
            
            return { valid: true };
        }

        // File input handlers with validation
        document.getElementById('videoFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const validation = validateFile(file, 'video');
            const fileNameElement = document.getElementById('videoFileName');
            
            if (!validation.valid) {
                fileNameElement.textContent = `❌ Error: ${validation.error}`;
                fileNameElement.style.color = 'var(--danger-color)';
                e.target.value = '';
            } else {
                fileNameElement.textContent = '✓ ' + file.name;
                fileNameElement.style.color = 'var(--success-color)';
            }
        });

        document.getElementById('sopFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const validation = validateFile(file, 'sop');
            const fileNameElement = document.getElementById('sopFileName');
            
            if (!validation.valid) {
                fileNameElement.textContent = `❌ Error: ${validation.error}`;
                fileNameElement.style.color = 'var(--danger-color)';
                e.target.value = '';
            } else {
                fileNameElement.textContent = '✓ ' + file.name;
                fileNameElement.style.color = 'var(--success-color)';
            }
        });

        // Form submission with enhanced error handling and CSRF protection
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const videoFile = document.getElementById('videoFile').files[0];
            const sopFile = document.getElementById('sopFile').files[0];
            
            // Validate both files
            const videoValidation = validateFile(videoFile, 'video');
            const sopValidation = validateFile(sopFile, 'sop');
            
            if (!videoValidation.valid || !sopValidation.valid) {
                alert(videoValidation.error || sopValidation.error);
                return;
            }
            
            formData.append('video', videoFile);
            formData.append('sop', sopFile);
            formData.append('csrf_token', document.querySelector('meta[name="csrf-token"]')?.content);
            
            const loadingOverlay = document.getElementById('loadingOverlay');
            const submitBtn = document.getElementById('submitBtn');
            
            try {
                loadingOverlay.classList.add('active');
                submitBtn.disabled = true;
                document.querySelector('.loading-content p').textContent = 'Processing...';
                
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                globalChecklistData = result.checklist;
                globalReportMarkdown = result.report_markdown;
                
                await displayAnalysisReport(result.report_markdown);
                await displayChecklistWithAnimation(result.checklist);
                
                document.getElementById('analysisCard').style.display = 'block';
                document.getElementById('analysisCard').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error analyzing files: ' + (error.message || 'Unknown error occurred'));
            } finally {
                loadingOverlay.classList.remove('active');
                submitBtn.disabled = false;
            }
        });

        // Display analysis report
        function displayAnalysisReport(markdown) {
            const content = document.getElementById('analysisContent');
            content.innerHTML = marked.parse(markdown);
        }

        // Display checklist with progressive animation
        async function displayChecklistWithAnimation(checklist) {
            const container = document.getElementById('checklistContainer');
            const progressContainer = document.getElementById('checklistProgress');
            
            if (!checklist || checklist.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-clipboard"></i><p>No checklist items available</p></div>';
                return;
            }
            
            container.innerHTML = '';
            progressContainer.style.display = 'block';
            
            // Group items by step
            const groupedChecklist = {};
            checklist.forEach(item => {
                if (!groupedChecklist[item.step]) {
                    groupedChecklist[item.step] = [];
                }
                groupedChecklist[item.step].push(item);
            });
            
            // Create step sections
            Object.entries(groupedChecklist).forEach(([step, items], stepIndex) => {
                const stepSection = document.createElement('div');
                stepSection.className = 'step-section';
                stepSection.innerHTML = `
                    <div class="step-header">
                        <h3>${step}</h3>
                    </div>
                `;
                
                // Add items to step section
                items.forEach((item, index) => {
                    const itemDiv = createChecklistItem(item, 'analyzing', `${stepIndex}-${index}`);
                    stepSection.appendChild(itemDiv);
                });
                
                container.appendChild(stepSection);
            });
            
            // Animate items
            let satisfiedCount = 0;
            const allItems = checklist;
            
            (async () => {
                for (let i = 0; i < allItems.length; i++) {
                    await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));
                    
                    const item = allItems[i];
                    const stepIndex = Object.keys(groupedChecklist).findIndex(step => step === item.step);
                    const itemIndex = groupedChecklist[item.step].findIndex(stepItem => stepItem === item);
                    const isSatisfied = item.satisfied === true;
                    
                    if (isSatisfied) satisfiedCount++;
                    
                    updateChecklistItemStatus(`${stepIndex}-${itemIndex}`, isSatisfied ? 'satisfied' : 'not-satisfied', item);
                    updateChecklistProgress(allItems.length, satisfiedCount);
                }
            })();
        }

        function createChecklistItem(item, status, index) {
            const itemDiv = document.createElement('div');
            itemDiv.className = `checklist-item ${status}`;
            itemDiv.id = `checklist-item-${index}`;
            
            const statusIcon = status === 'analyzing' ? '<i class="fas fa-sync-alt"></i>' : 
                              status === 'satisfied' ? '<i class="fas fa-check"></i>' : 
                              '<i class="fas fa-times"></i>';
            
            const timestamps = item.timestamps && item.timestamps.length > 0
                ? item.timestamps.map(t => `<span class="timestamp-badge">${t}</span>`).join('')
                : '';
            
            itemDiv.innerHTML = `
                <div class="status-circle ${status}" id="status-circle-${index}">
                    ${statusIcon}
                </div>
                <div class="item-content">
                    <div class="item-text">${item.point}</div>
                    <div class="item-evidence" id="evidence-${index}">${status === 'analyzing' ? 'Analyzing...' : (item.evidence || 'No additional evidence provided')}</div>
                    ${timestamps ? `<div class="item-timestamps" id="timestamps-${index}">${timestamps}</div>` : '<div class="item-timestamps" id="timestamps-${index}"></div>'}
                </div>
                <div class="menu-dots" onclick="toggleMenu(event, ${index})">
                    <i class="fas fa-ellipsis-v"></i>
                    <div class="menu-dropdown" id="menu-${index}">
                        <div class="menu-item" onclick="markAsCompleted(event, ${index})">
                            <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                            Mark as Completed
                        </div>
                    </div>
                </div>
            `;
            
            return itemDiv;
        }

        function updateChecklistItemStatus(index, status, item) {
            const itemDiv = document.getElementById(`checklist-item-${index}`);
            const statusCircle = document.getElementById(`status-circle-${index}`);
            const evidenceDiv = document.getElementById(`evidence-${index}`);
            const timestampsDiv = document.getElementById(`timestamps-${index}`);
            
            if (!itemDiv || !statusCircle) return;
            
            // Remove all status classes
            itemDiv.className = `checklist-item ${status}`;
            statusCircle.className = `status-circle ${status} checkmark-animation`;
            
            // Update icon
            if (status === 'satisfied') {
                statusCircle.innerHTML = '<i class="fas fa-check"></i>';
            } else if (status === 'not-satisfied') {
                statusCircle.innerHTML = '<i class="fas fa-times"></i>';
            }
            
            // Update evidence
            if (item && evidenceDiv) {
                evidenceDiv.textContent = item.evidence || 'No additional evidence provided';
            }
            
            // Update timestamps
            if (item && item.timestamps && item.timestamps.length > 0 && timestampsDiv) {
                const timestamps = item.timestamps.map(t => `<span class="timestamp-badge">${t}</span>`).join('');
                timestampsDiv.innerHTML = timestamps;
            }
        }

        function updateChecklistProgress(total, completed) {
            const progressPercent = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('progressText').textContent = `${completed}/${total}`;
            const progressBar = document.getElementById('checklistProgressBar');
            progressBar.style.width = progressPercent + '%';
            progressBar.textContent = Math.round(progressPercent) + '%';
        }

        // Three-dot menu functions
        function toggleMenu(event, index) {
            event.stopPropagation();
            const menu = document.getElementById(`menu-${index}`);
            
            // Close all other menus
            document.querySelectorAll('.menu-dropdown').forEach(m => {
                if (m.id !== `menu-${index}`) m.classList.remove('active');
            });
            
            menu.classList.toggle('active');
        }

        async function markAsCompleted(event, index) {
            event.stopPropagation();
            
            // Close menu
            document.getElementById(`menu-${index}`).classList.remove('active');
            
            // Update UI to satisfied status
            const item = globalChecklistData[index];
            item.satisfied = true;
            updateChecklistItemStatus(index, 'satisfied', item);
            
            // Recalculate progress
            const satisfiedCount = globalChecklistData.filter(item => item.satisfied).length;
            updateChecklistProgress(globalChecklistData.length, satisfiedCount);
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.closest('.menu-dots')) {
                document.querySelectorAll('.menu-dropdown').forEach(m => m.classList.remove('active'));
            }
        });

        // Download HTML function
        function downloadHTML() {
            const reportContent = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturing Video Analysis Report</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; line-height: 1.6; color: #2d3748; background: #f7fafc; padding: 40px 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 60px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 8px; }
        .header { text-align: center; margin-bottom: 50px; border-bottom: 3px solid #667eea; padding-bottom: 30px; }
        .header h1 { color: #667eea; font-size: 36px; margin-bottom: 10px; }
        .header p { color: #718096; font-size: 16px; }
        .report-meta { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 40px; }
        .report-meta p { margin: 8px 0; color: #4a5568; }
        .report-meta strong { color: #2d3748; }
        h1, h2, h3 { color: #667eea; margin-top: 30px; margin-bottom: 15px; }
        h1 { font-size: 32px; }
        h2 { font-size: 26px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        h3 { font-size: 20px; }
        p { margin-bottom: 15px; color: #4a5568; }
        ul, ol { margin-left: 30px; margin-bottom: 20px; }
        li { margin-bottom: 10px; color: #4a5568; }
        table { width: 100%; border-collapse: collapse; margin: 25px 0; }
        table th { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; text-align: left; font-weight: 600; }
        table td { padding: 12px 15px; border-bottom: 1px solid #e2e8f0; }
        table tr:hover { background: #f8f9fa; }
        code { background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #e53e3e; }
        pre { background: #f1f5f9; padding: 20px; border-radius: 8px; overflow-x: auto; margin: 20px 0; }
        .checklist-section { margin-top: 50px; }
        .checklist-item { background: #f8f9fa; border-left: 4px solid #cbd5e0; padding: 20px; margin-bottom: 15px; border-radius: 6px; }
        .checklist-item.satisfied { background: #d4edda; border-left-color: #10b981; }
        .checklist-item.not-satisfied { background: #fee; border-left-color: #ef4444; }
        .checklist-item h4 { color: #2d3748; margin-bottom: 8px; font-size: 16px; }
        .checklist-item p { margin-bottom: 8px; font-size: 14px; }
        .checklist-item .status { font-weight: 600; margin-bottom: 5px; }
        .checklist-item .status.satisfied { color: #10b981; }
        .checklist-item .status.not-satisfied { color: #ef4444; }
        .timestamp { display: inline-block; background: rgba(102, 126, 234, 0.1); color: #667eea; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-right: 6px; margin-top: 6px; }
        .footer { margin-top: 60px; padding-top: 30px; border-top: 2px solid #e2e8f0; text-align: center; color: #94a3b8; font-size: 14px; }
        @media print { body { padding: 0; } .container { box-shadow: none; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Manufacturing Video Analysis Report</h1>
            <p>AI-Powered Safety & Process Monitoring</p>
        </div>

        <div class="report-meta">
            <p><strong>Report Generated:</strong> ${new Date().toLocaleString()}</p>
            <p><strong>Analysis Type:</strong> SOP Compliance Verification</p>
            <p><strong>Compliance Rate:</strong> ${calculateComplianceRate()}%</p>
        </div>

        <div class="report-content">
            ${marked.parse(globalReportMarkdown)}
        </div>

        <div class="checklist-section">
            <h2>SOP Compliance Checklist</h2>
            ${generateChecklistHTML()}
        </div>

        <div class="footer">
            <p>This report was generated by Manufacturing Video Analysis System</p>
            <p>© ${new Date().getFullYear()} - All Rights Reserved</p>
        </div>
    </div>
</body>
</html>
            `;

            const blob = new Blob([reportContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `manufacturing-analysis-report-${Date.now()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function calculateComplianceRate() {
            if (!globalChecklistData || globalChecklistData.length === 0) return 0;
            const satisfiedCount = globalChecklistData.filter(item => item.satisfied).length;
            return Math.round((satisfiedCount / globalChecklistData.length) * 100);
        }

        function generateChecklistHTML() {
            if (!globalChecklistData || globalChecklistData.length === 0) {
                return '<p>No checklist items available</p>';
            }

            return globalChecklistData.map((item, index) => {
                const statusClass = item.satisfied ? 'satisfied' : 'not-satisfied';
                const statusText = item.satisfied ? 'Satisfied ✓' : 'Not Satisfied ✗';
                const timestamps = item.timestamps && item.timestamps.length > 0
                    ? item.timestamps.map(t => `<span class="timestamp">${t}</span>`).join('')
                    : '';

                return `
                    <div class="checklist-item ${statusClass}">
                        <p class="status ${statusClass}">${statusText}</p>
                        <h4>${index + 1}. ${item.point}</h4>
                        <p><strong>Evidence:</strong> ${item.evidence || 'No additional evidence provided'}</p>
                        ${timestamps ? `<div><strong>Timestamps:</strong> ${timestamps}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>